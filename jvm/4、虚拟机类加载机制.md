# 虚拟机类加载机制

## 1.1 类加载的时机

​		类型从加载到内存开始到卸载出内存为止，整个生命周期会经历**加载（loading）、验证（Verification）、准备（Preparation）、解析（Resolution）、初始化（Initialization）、使用（Using）、卸载（Unloading）**七个阶段。其中**验证、准备、解析三个阶段称为连接（Linking）**。如下图：

![image-20210113134152946](C:\Users\User\AppData\Roaming\Typora\typora-user-images\image-20210113134152946.png)

​		其中加载、验证、准备、初始化和卸载这五个阶段的顺序是确定的，而解析阶段则不一定：为了支持Java语言的运行时绑定特性（也称为动态绑定或晚期绑定），会再初始化阶段后在开始解析阶段。当然这些阶段通常也都是互相交叉地混合进行的。

​		对于初始化阶段，《Java虚拟机规范》则是严格规定了有且只有六种情况必须立即对类进行“初始化”（而加载、连接自然需要在此之前开始）：

1. 遇到new、getstatic 、putstatic或invokestatic这四条字节码指令时，类型没有初始化需要先触发其初始化阶段。生成这四条指令的典型Java代码场景有：
   - 使用new关键字实例化对象
   - 读取或设置类型的静态字段（被final修饰、已在编译期把结果放入常量池的静态字段除外）
   - 调用类型的静态方法
   
2. 使用java.lang.reflect 包的方法对类型进行反射调用，如果没有初始化，回先触发初始化

3. 初始化类型时，如果其父类没有初始化，会先触发父类初始化

4. 当虚拟机启动时，会先初始化用户指定的包含main（）的主类

5. 使用JDK 7 的动态语言支持时，如果java.lang.invoke.MethodHandle实例最后解析结果为REF_getStatic 、REF_putStatic 、REF_invokeStatic、REF_newInvokeSpecial四种类型的方法句柄，并且对应的方法句柄的类没有初始化，则先触发初始化

6. 接口中定义JDK 8 新加入的默认方法（被default关键字修饰的接口方法），当接口实现类发生初始化，会先初始化该接口

   ​	

   ​	这六种场景中的行为称为对一个类型进行主动引用。此外，所有引用类型的方式都不会触发初始化，称为被动引用。

   1. 通过子类引用父类的静态字段，不会导致子类初始化
   
   2. 通过数组定义来引用类，不会触发此类的初始化
   
   3. 常量在编译阶段会存入调用类的常量，本质上没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化
   
      **接口与类初始化的区别**
   
      类型初始化时，要求其分类全部以及初始化过，但是接口初始化是，并不要求父接口全部都完成初始化，只有使用到才会初始化。

## 1.2 类加载的过程

### 1.2.1 加载

加载阶段主要完成的工作有：

1. **通过类的全限定名来获取定义此类的二进制字节流。**
2. **将字节流所代表的静态存储结构转化为方法区的运行时数据结构。**
3. **在内存中生成一个代表这个类的java.lang.Class对象，作为方法区该类的数据的访问入口。**

​		《Java虚拟机规范》对这三点要求并不具体，灵活度很大，仅第一条条件就有好多种技术建立在此基础之上，如动态代理、class文件反编译加密、从zip包中读取（最终成为日后JAR、EAR、WAR格式的基础）。

​		数组类不通过类加载器创建，由虚拟机直接在内存中动态构造出来，但是数组类的元素类型[^一]最终是要类加载器加载完成，数组类的创建过程遵循以下规则：

* 如果数组的组件类型[^二]是引用类型，那就递归采用本节中定义的加载过程去加载这个组件类型，数组类将被标识在加载该组件类型的类加载器的类名称空间上（一个类型必须与类加载器一起确定唯一性）。
* 如果数组的组件类型不是引用类型（例如int[] 数组的组件类型为int），Java虚拟机将会把数组类标记为引导类加载器关联。
* 数组类的可访问性与它的组件类型的可访问性一致，如果组件类型不是引用类型，它的数组类的可访问性将默认为public，可被所有类和接口访问。

​		加载阶段于连接阶段的部分动作（如一部分字节码文件格式验证动作）是交叉进行的，但是开始时间仍然保持固定先后顺序。

### 1.2.2 验证

#### 1.2.2.1 文件格式验证

#### 1.2.2.2 元数据验证

#### 1.2.2.3 字节码验证

#### 1.2.2.4 符号引用验证

### 1.2.3 准备

### 1.2.4 解析

#### 1.2.4.1 类或接口的解析

#### 1.2.4.2 字段解析

#### 1.2.4.3 方法解析

### 1.2.5 初始化

## 1.3 类加载器



[^一]: Element Type ,指数组去掉所有维度的类型
[^二]: Component Type ，指数组去掉一个维度的类型